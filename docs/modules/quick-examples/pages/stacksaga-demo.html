<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.20">
<meta name="description" content="StackSaga Quick Start With Kubernetes">
<meta name="keywords" content="SatckSaga Spring microservice,spring boot saga,spring cloud microservice saga, saga design pattern,saga orchestration spring boot">
<title>StackSaga Demo (Core concept practice)</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="article">
<div id="header">
<h1>StackSaga Demo (Core concept practice)</h1>
</div>
<div id="content">
<div class="sect1">
<h2 id="_overview">Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this demo, we are focusing on how to implement the StackSaga things in the spring boot in microservice architecture.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>IF you are new to StackSaga, it is recommitted to read the <a href="../../architecture/pages/aggregator.html">architecture</a> and <a href="../../framework/pages/create-aggregator.html">reference documentation</a>
for read individual components.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>In this example, we have 4 utility microservices called <code>order-service</code>, <code>user-service</code>, <code>payment-service</code>, and <code>stock-service.</code> in addition to that,
<a href="https://spring.io/projects/spring-cloud-gateway">Spring Cloud Api Gateway</a> is used as the proxy server and as well as the Application Load Balancer (ALB).
and also Eureka Discovery is used for service registry.</p>
</div>
<div class="paragraph">
<p>The use-case is the clients can palace an order and then the order request should be completed go through these 4 services.</p>
</div>
<div class="paragraph">
<p>Each services' responsibilities as follows.</p>
</div>
<div class="hdlist">
<table>
<tr>
<td class="hdlist1">
<code><strong>order-service</strong></code>
</td>
<td class="hdlist2">
<p>Order service is responsible for accepting the place order request and managing the entire transaction as the <a href="#//">orchestrator</a>.
and also as a utility service, the service is responsible for storing the order related specific data in the order-service database.
According to this us-case, This is the service that stacksaga is added.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code><strong>user-service</strong></code>
</td>
<td class="hdlist2">
<p>To make the process we want to have the user details like delivery address.
<code>user-service</code> managing the user-related data, and it provides endpoints to fetch the user&#8217;s data.</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<code><strong>payment-service</strong></code>
</td>
<td class="hdlist2">
<p>In the placing order process, the utility <code>payment-service</code> involves to two main tasks.</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>To make the <strong>Pre-Auth</strong> before doing the real transaction and to check that the payment can be done or not.</p>
</li>
<li>
<p>To make the payment (Real transaction).
All the steps are done smoothly finally the reserved transaction should be made.
These endpoints are provided by the <code>payment-service</code>.</p>
</li>
</ol>
</div>
</td>
</tr>
<tr>
<td class="hdlist1">
<code><strong>stock-service</strong></code>
</td>
<td class="hdlist2">
<p>After making the pre-auth process, we should update the real stock.
<code>stock-service</code> is responsible for providing endpoints to update the real stock and restore the update.</p>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>All the services that we are going to build.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>api-cloud-gateway</p>
</li>
<li>
<p>eureka-service</p>
</li>
<li>
<p>utility servers</p>
<div class="ulist">
<ul>
<li>
<p>order-service</p>
</li>
<li>
<p>user-service</p>
</li>
<li>
<p>stock-service</p>
</li>
<li>
<p>payment-service</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Additionally <code>stackasga-admin-dashboard</code> is run monitoring the transactions.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>source code is available on //[Github].</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>This guide is divided into 3 sections for your convenience.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">[1] Implementation</dt>
<dd>
<p>Guides for implementing all java classes. (focus the StackSaga concepts)</p>
</dd>
<dt class="hdlist1">[2] Deployment</dt>
<dd>
<p>Guides for creating and connecting The API-gateway and eureka service with utility services with all the configurations.</p>
</dd>
<dt class="hdlist1">[3] Testing</dt>
<dd>
<p>Testing the application by running all the applications together.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_high_level_implementation_diagram">High-level Implementation Diagram.</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Here you can see what we are going to build in High-level.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../images/stacksaga-example-stacksaga-eureka-spring-cloud-api-gateway-demo-hight-level.drawio.svg" alt="stacksaga example stacksaga eureka spring cloud api gateway microservice demo hight level.">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>In the diagram, StackSaga icons <span class="image"><img src="../images/stack-saga-icon.svg" alt="stack saga icon" width="20"></span> are shown which parts StackSaga interact.</p>
</li>
<li>
<p>Red lines are shown how the StackSaga Admin interacts with the process and the request-flow.</p>
</li>
<li>
<p>Black lines are shown how the regular http requests are done.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementation">Implementation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As the first step, we are going to create the Orchestrator Service called <code>order-service</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Even if there are 4 utility services in the diagram, we mainly focus the order service only.
Other services are traditional spring boot services, and there is nothing to discuss.<br>
You can download the full source code from //here.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_create_order_service_orchestrator_service">Create Order-Service (Orchestrator Service)</h3>
<div class="paragraph">
<p>The <code>order-service</code> is little bit spacial than the other utility servers because the <code>order-service</code> is the responsible for managing the entire transaction here.
That&#8217;s why it called as <a href="#//">Orchestrator Service</a>.
And the next reason is that StackSaga involves that kind of service in your entire system.
Selecting a service as an Orchestrator service or not depends on your rearmament.</p>
</div>
<div class="sect3">
<h4 id="_create_order_the_project_with_spring_initializer">Create order the project with spring initializer</h4>
<div class="paragraph">
<p>Go to the <a href="https://start.spring.io/">spring initializer</a> and create your project with the following Dependencies.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>spring-boot-starter-web</code></p>
</li>
<li>
<p><code>spring-boot-starter-data-jpa</code></p>
</li>
<li>
<p><code>mysql-connector-java</code></p>
</li>
<li>
<p><code>lombok</code></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In general, you would add <code>spring-eureka-client</code> but in this example eureka is not used.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After creating your project, add the StackSaga dependencies in the dependencies section.
There are 3 dependencies to be added based on your implementation.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You can add the <code>stacksaga-spring-boot-starter</code> dependency based on the spring version that you wish to use.
<mark>In this example, we will be using spring2.X.</mark></p>
<div class="dlist">
<dl>
<dt class="hdlist1">Spring 2.X</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span style="color:#070;font-weight:bold">&lt;dependency&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;groupId&gt;</span>org.stacksaga<span style="color:#070;font-weight:bold">&lt;/groupId&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;artifactId&gt;</span>stacksaga-spring-boot-2-starter<span style="color:#070;font-weight:bold">&lt;/artifactId&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;version&gt;</span>1.0.0<span style="color:#070;font-weight:bold">&lt;/version&gt;</span>
<span style="color:#070;font-weight:bold">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</dd>
<dt class="hdlist1">Spring 3.X</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span style="color:#070;font-weight:bold">&lt;dependency&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;groupId&gt;</span>org.stacksaga<span style="color:#070;font-weight:bold">&lt;/groupId&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;artifactId&gt;</span>stacksaga-spring-boot-2-starter<span style="color:#070;font-weight:bold">&lt;/artifactId&gt;</span>
  <span style="color:#070;font-weight:bold">&lt;version&gt;</span>1.0.0<span style="color:#070;font-weight:bold">&lt;/version&gt;</span>
<span style="color:#070;font-weight:bold">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</dd>
</dl>
</div>
</li>
<li>
<p>Due to the database has been selected as Mysql, you have to add <code>stacksaga-mysql-support</code> dependency.</p>
<div class="dlist">
<dl>
<dt class="hdlist1">:</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span style="color:#070;font-weight:bold">&lt;dependency&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;groupId&gt;</span>org.stacksaga<span style="color:#070;font-weight:bold">&lt;/groupId&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;artifactId&gt;</span>stacksaga-mysql-support<span style="color:#070;font-weight:bold">&lt;/artifactId&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;version&gt;</span>1.0.0<span style="color:#070;font-weight:bold">&lt;/version&gt;</span>
<span style="color:#070;font-weight:bold">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</dd>
</dl>
</div>
</li>
<li>
<p>Due to we are going to deploy the application in the Kubernetes cluster environment, <code>stacksaga-connect-k8s-support</code> dependency should be added.</p>
<div class="dlist">
<dl>
<dt class="hdlist1">:</dt>
<dd>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span style="color:#070;font-weight:bold">&lt;dependency&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;groupId&gt;</span>org.stacksaga<span style="color:#070;font-weight:bold">&lt;/groupId&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;artifactId&gt;</span>stacksaga-connect-k8s-support<span style="color:#070;font-weight:bold">&lt;/artifactId&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;version&gt;</span>1.0.0<span style="color:#070;font-weight:bold">&lt;/version&gt;</span>
<span style="color:#070;font-weight:bold">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</dd>
</dl>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Finally, the <code>pom.xml</code> file will be like below.</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/stacksaga/stacksaga-examples/blob/main/stacksaga-demo-for-kubernetes/order-service/pom.xml"><span class="icon black"><i class="fa fa-github fa-2x"></i></span></a> pom.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span style="color:#579">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span style="color:#070;font-weight:bold">&lt;project</span> <span style="color:#b48">xmlns</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">http://maven.apache.org/POM/4.0.0</span><span style="color:#710">&quot;</span></span>
         <span style="color:#b48">xmlns:xsi</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">http://www.w3.org/2001/XMLSchema-instance</span><span style="color:#710">&quot;</span></span>
         <span style="color:#b48">xsi:schemaLocation</span>=<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd</span><span style="color:#710">&quot;</span></span><span style="color:#070;font-weight:bold">&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;modelVersion&gt;</span>4.0.0<span style="color:#070;font-weight:bold">&lt;/modelVersion&gt;</span>

    <span style="color:#070;font-weight:bold">&lt;parent&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#070;font-weight:bold">&lt;/groupId&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;artifactId&gt;</span>spring-boot-starter-parent<span style="color:#070;font-weight:bold">&lt;/artifactId&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;version&gt;</span>2.7.0<span style="color:#070;font-weight:bold">&lt;/version&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;relativePath</span><span style="color:#070;font-weight:bold">/&gt;</span> <span style="color:#777">&lt;!-- lookup parent from repository --&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;/parent&gt;</span>

    <span style="color:#070;font-weight:bold">&lt;groupId&gt;</span>org.example<span style="color:#070;font-weight:bold">&lt;/groupId&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;artifactId&gt;</span>order-service<span style="color:#070;font-weight:bold">&lt;/artifactId&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;version&gt;</span>1.0-SNAPSHOT<span style="color:#070;font-weight:bold">&lt;/version&gt;</span>

    <span style="color:#070;font-weight:bold">&lt;properties&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;maven.compiler.source&gt;</span>8<span style="color:#070;font-weight:bold">&lt;/maven.compiler.source&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;maven.compiler.target&gt;</span>8<span style="color:#070;font-weight:bold">&lt;/maven.compiler.target&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;project.build.sourceEncoding&gt;</span>UTF-8<span style="color:#070;font-weight:bold">&lt;/project.build.sourceEncoding&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;spring-cloud.version&gt;</span>2021.0.3<span style="color:#070;font-weight:bold">&lt;/spring-cloud.version&gt;</span>
    <span style="color:#070;font-weight:bold">&lt;/properties&gt;</span>

    <span style="color:#070;font-weight:bold">&lt;dependencies&gt;</span>

        ...
        ...
        <span style="color:#777">&lt;!--othe dependencies--&gt;</span>

        <span style="color:#777">&lt;!--StackSaga related dependacies --&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;dependency&gt;</span>
            <span style="color:#070;font-weight:bold">&lt;groupId&gt;</span>org.stacksaga<span style="color:#070;font-weight:bold">&lt;/groupId&gt;</span>
            <span style="color:#070;font-weight:bold">&lt;artifactId&gt;</span>stacksaga-spring-boot-2-starter<span style="color:#070;font-weight:bold">&lt;/artifactId&gt;</span>
            <span style="color:#070;font-weight:bold">&lt;version&gt;</span>1.0.0<span style="color:#070;font-weight:bold">&lt;/version&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;/dependency&gt;</span>

        <span style="color:#070;font-weight:bold">&lt;dependency&gt;</span>
            <span style="color:#070;font-weight:bold">&lt;groupId&gt;</span>org.stacksaga<span style="color:#070;font-weight:bold">&lt;/groupId&gt;</span>
            <span style="color:#070;font-weight:bold">&lt;artifactId&gt;</span>stacksaga-mysql-support<span style="color:#070;font-weight:bold">&lt;/artifactId&gt;</span>
            <span style="color:#070;font-weight:bold">&lt;version&gt;</span>1.0.0<span style="color:#070;font-weight:bold">&lt;/version&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;/dependency&gt;</span>

        <span style="color:#070;font-weight:bold">&lt;dependency&gt;</span>
            <span style="color:#070;font-weight:bold">&lt;groupId&gt;</span>org.stacksaga<span style="color:#070;font-weight:bold">&lt;/groupId&gt;</span>
            <span style="color:#070;font-weight:bold">&lt;artifactId&gt;</span>stacksaga-connect-k8s-support<span style="color:#070;font-weight:bold">&lt;/artifactId&gt;</span>
            <span style="color:#070;font-weight:bold">&lt;version&gt;</span>1.0.0<span style="color:#070;font-weight:bold">&lt;/version&gt;</span>
        <span style="color:#070;font-weight:bold">&lt;/dependency&gt;</span>

    <span style="color:#070;font-weight:bold">&lt;/dependencies&gt;</span>
<span style="color:#070;font-weight:bold">&lt;/project&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_creating_the_aggregator">Creating the aggregator</h4>
<div class="paragraph">
<p>You know that the request comes to the order-service at the first (for downstream services), and it tries to handle the entire request by calling to other utility services.
To start the execute the request, the <code>order-service</code> should have an Aggregator class that extend from the <code>SagaAggregator</code> class.
And as well as to verify the aggregator object is serializable well or not, we should provide a <a href="../../framework/pages/aggregator_serialization.html">sagaSerializable</a>'s implementation.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Read the <a href="#//">reference documentation</a>
to have a better understanding and best practices regarding the <code>SagaAggregator</code>.</p>
</div>
</blockquote>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#080;font-weight:bold">package</span> <span style="color:#707;font-weight:bold">org.example.aggregator</span>;

<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">com.fasterxml.jackson.annotation.JsonProperty</span>;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">lombok.Getter</span>;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">lombok.Setter</span>;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.example.aggregator.dto.OrderItem</span>;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.stacksaga.Aggregator</span>;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.stacksaga.SagaSerializable</span>;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.stacksaga.core.annotation.SagaAggregator</span>;
<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">org.stacksaga.core.annotation.SagaAggregatorVersion</span>;

<span style="color:#080;font-weight:bold">import</span> <span style="color:#B44;font-weight:bold">java.util.List</span>;

<span style="color:#007">@SagaAggregator</span>(
        version = <span style="color:#007">@SagaAggregatorVersion</span>(major = <span style="color:#00D">1</span>, minor = <span style="color:#00D">0</span>, patch = <span style="color:#00D">0</span>),
        name = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">PlaceOrderAggregator</span><span style="color:#710">&quot;</span></span>,
        sagaSerializable = PlaceOrderAggregatorSerializer.class
)
<span style="color:#007">@Getter</span>
<span style="color:#007">@Setter</span>
<span style="color:#007">@ToString</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">PlaceOrderAggregator</span> <span style="color:#088;font-weight:bold">extends</span> Aggregator {


    <span style="color:#777">/**
     * The relevant user to the order.
     */</span>
    <span style="color:#007">@JsonProperty</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">user_id</span><span style="color:#710">&quot;</span></span>)
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">String</span> userId;
    <span style="color:#777">/**
     * The item list that user order.
     */</span>
    <span style="color:#007">@JsonProperty</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">items</span><span style="color:#710">&quot;</span></span>)
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">List</span>&lt;OrderItem&gt; items;

    <span style="color:#777">/**
     * The amount to be paid.
     */</span>
    <span style="color:#007">@JsonProperty</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">amount</span><span style="color:#710">&quot;</span></span>)
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">Double</span> amount;

    <span style="color:#777">/**
     * Pre-Auth Reference for release or make the payment.
     */</span>
    <span style="color:#007">@JsonProperty</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">pre_auth_ref</span><span style="color:#710">&quot;</span></span>)
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">String</span> preAuthRef;

    <span style="color:#777">/**
     * Payment ID after the payment.
     */</span>
    <span style="color:#007">@JsonProperty</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">payment_id</span><span style="color:#710">&quot;</span></span>)
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#0a8;font-weight:bold">String</span> paymentId;


    <span style="color:#088;font-weight:bold">public</span> PlaceOrderAggregator() {
        <span style="color:#950">super</span>(PlaceOrderAggregator.class);
    }
}


<span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">PlaceOrderAggregatorSerializer</span> <span style="color:#088;font-weight:bold">extends</span> SagaSerializable&lt;PlaceOrderAggregator&gt; {

    <span style="color:#088;font-weight:bold">public</span> PlaceOrderAggregatorSerializer() {
        PlaceOrderAggregator placeOrderAggregator = <span style="color:#080;font-weight:bold">new</span> PlaceOrderAggregator();
        placeOrderAggregator.setUserId(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">user-1</span><span style="color:#710">&quot;</span></span>);
        placeOrderAggregator.setAmount(<span style="color:#60E">100.00</span>);
        placeOrderAggregator.setItems(<span style="color:#080;font-weight:bold">new</span> <span style="color:#0a8;font-weight:bold">ArrayList</span>&lt;&gt;());
        placeOrderAggregator.getItems()
                .add(OrderItem.builder()
                        .itemId(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">item-1</span><span style="color:#710">&quot;</span></span>)
                        .itemPrice(<span style="color:#60E">100.00</span>)
                        .build()
                );
        <span style="color:#950">this</span>.put(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">sample-1</span><span style="color:#710">&quot;</span></span>, placeOrderAggregator);
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
To make the code more readable and clear, I have used <a href="https://projectlombok.org/:"><code>lombok</code></a>
and builder pattern for creating the objects through the demo.
It is not required, and you are free to use the traditional way by creating getters and setters manual.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the <code>PlaceOrderAggregator</code> has the data that we want to access while the transaction process.
Those data will be updated time to time for each execution.</p>
</div>
<div class="paragraph">
<p>Now the aggregator is ready to store and carry out the data throughout the entire process.</p>
</div>
</div>
<div class="sect3">
<h4 id="_creating_executors">Creating executors</h4>
<div class="paragraph">
<p>You know that we have to access more services except this <code>order-service</code> to fully complete the place-order request.
To access those services in general, you would use <strong>service-layer</strong> and call those services by using any httpclient like RestTemplate, Feign client, Okhttp, and so on.
But in the <a href="#//">Saga design pattern</a>, you know that we should have a compensation process for all the execution (All the executions that make some changes in a database).
Due to the fact that the StackSaga framework is one of Saga implementations, it should be provided the main execution and also a compensation execution to make a compensation when the entire process is failed at any point.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Read the <a href="#//">reference documentation</a>
to have a better understanding and best practices regarding the <code>SagaExecutors</code>.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>StackSaga doesn&#8217;t bother to that layer.
In StackSaga, In addition to that layer you have to implement a new layer called <code><strong>executor-layer</strong></code>.
In the executor-layer, you can create your executors.</p>
</div>
<div class="paragraph">
<p>All the <strong>process-executions</strong> (The regular execution to make the process) and <strong>revert-executions</strong> (The compensation executions to undo the made changes by process-executions) with the relevant services are summarized in the following table and the diagram.</p>
</div>
<div class="openblock scrollable">
<div class="content">
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Executor Class Name</th>
<th class="tableblock halign-left valign-top">Execution_Requirement</th>
<th class="tableblock halign-left valign-top">Target_Service</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Process-Execution</th>
<th class="tableblock halign-left valign-top">Revert-Execution</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#//"><code>OrderInitializeExecutor</code></a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Initialize the order at the first.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>order-service</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong class="badge-yellow">COMMAND_EXECUTOR</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>initializeOrder()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cancelOrder()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#//"><code>UserDetailExecutor</code></a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fetch the user&#8217;s details</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>user-service</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong class="badge-green">QUERY_EXECUTOR</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>getUserDetails</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#//"><code>PreAuthExecutor</code></a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Make the Pre-Auth process.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>payment-service</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong class="badge-yellow">COMMAND_EXECUTOR</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>makePreAuth()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>releasePreAuth()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#//"><code>StockUpdateExecutor</code></a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Update the stock from the store.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>stock-service</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong class="badge-yellow">COMMAND_EXECUTOR</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>updateStock()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>restoreStock()</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#//"><code>MakePaymentExecutor</code></a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Finalize the order by making the real payment.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>payment-service</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong class="badge-yellow">COMMAND_EXECUTOR</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>makePayment()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">?</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="paragraph">
<p><span class="image"><img src="../images/stacksaga-example-executors.drawio.svg" alt="stacksaga-example executors digram."></span></p>
</div>
<div class="paragraph">
<p>In the diagram, you can see cleanly what we are going to build inside the order-service and how they connect with other services.</p>
</div>
<div class="paragraph">
<p>Even though the class creation should be started from the repository-layer, let&#8217;s get started from the executor-layer for your convenience to understand.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_creating_ordercontroller_api_endpoint">Creating OrderController (API Endpoint).</h3>
<div class="paragraph">
<p>As per the diagram, you know that the request comes to the <code>/order/place</code> endpoint and also the handing over the execution to the stacksaga is happened in this controller class.</p>
</div>
<div id="orderController_source" class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@RestController</span>
<span style="color:#007">@RequestMapping</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">/order</span><span style="color:#710">&quot;</span></span>)
<span style="color:#007">@RequiredArgsConstructor</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">OrderController</span> {

    <i class="conum" data-value="1"></i><b>(1)</b>
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> SagaTemplate&lt;PlaceOrderAggregator&gt; placeOrderAggregatorSagaTemplate;

    <span style="color:#007">@PostMapping</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">/place</span><span style="color:#710">&quot;</span></span>)
    <span style="color:#007">@ResponseStatus</span>(HttpStatus.ACCEPTED)
    <span style="color:#088;font-weight:bold">public</span> PlaceOrderDto.ResponseBody createOrder(<span style="color:#007">@RequestBody</span> PlaceOrderDto.RequestBody requestBody) {
        <i class="conum" data-value="2"></i><b>(2)</b>
        <span style="color:#088;font-weight:bold">final</span> PlaceOrderAggregator placeOrderAggregator = <span style="color:#080;font-weight:bold">new</span> PlaceOrderAggregator();
        placeOrderAggregator.setUserId(requestBody.getUserId());
        placeOrderAggregator.setItems(requestBody.getItems());
        placeOrderAggregator.setAmount(
                requestBody.getItems()
                        .stream()
                        .map(orderItem -&gt; orderItem.getItemPrice() * orderItem.getQty())
                        .mapToDouble(<span style="color:#0a8;font-weight:bold">Double</span>::doubleValue)
                        .sum()
        );
        <i class="conum" data-value="3"></i><b>(3)</b>
        placeOrderAggregatorSagaTemplate.process(
                placeOrderAggregator,
                UserDetailExecutor.class
        );
        <i class="conum" data-value="4"></i><b>(4)</b>
        <span style="color:#080;font-weight:bold">return</span> PlaceOrderDto.ResponseBody.builder()
                .orderId(placeOrderAggregator.getAggregatorTransactionId())
                .message(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">order has been submitted successfully</span><span style="color:#710">&quot;</span></span>)
                .build();
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Autowire the <a href="../../framework/pages/saga_template.html">SagaTemplate</a> for handing over the execution to the framework.
Your target aggregator class should be provided to the <code>SagaTemplate</code> as a type.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Initialize the <a href="creating-aggregator.html">PlaceOrderAggregator</a>  [<a href="https://github.com/stacksaga/stacksaga-examples/blob/main/stacksaga-demo-for-kubernetes/order-service/src/main/java/org/example/aggregator/PlaceOrderAggregator.java"><span class="icon black"><i class="fa fa-github"></i></span></a>] and set the data that should be added initially.
In our case, the necessary data that are given from the endpoint are added to the aggregator object.
You can see the initialized data at the dashboard <a href="#//">like this</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Handing over the execution to the framework by passing the initialized aggregator object, and the executor class that the execution should be started.
From here the execution will be handled by the StackSaga execution coordinator <a href="#//">(SEC)</a> asynchronously.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Build the response object to the client by using the <code>aggregatorTransactionId</code>.
<code>aggregatorTransactionId</code> can access through your aggregator object due to that id comes from the <code>Aggregator</code> super.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Related Classes' links</p>
</div>
<div class="ulist">
<ul>
<li>
<p>[ <a href="https://github.com/stacksaga/stacksaga-examples/blob/main/stacksaga-demo-for-kubernetes/order-service/src/main/java/org/example/aggregator/PlaceOrderAggregator.java"><span class="icon black"><i class="fa fa-github"></i></span></a> ] <a href="#">PlaceOrderAggregator</a></p>
</li>
<li>
<p>[ <a href="https://github.com/stacksaga/stacksaga-examples/blob/main/stacksaga-demo-for-kubernetes/order-service/src/main/java/org/example/executor/UserDetailExecutor.java"><span class="icon black"><i class="fa fa-github"></i></span></a> ] xref:creating-UserDetailExecutor.adoc#creating_user_detail_executor`UserDetailExecutor`</p>
</li>
<li>
<p>[ <a href="https://github.com/stacksaga/stacksaga-examples/blob/main/stacksaga-demo-for-kubernetes/order-service/src/main/java/org/example/dto/PlaceOrderDto.java"><span class="icon black"><i class="fa fa-github"></i></span></a> ] <code>PlaceOrderDto.RequestBody</code></p>
</li>
<li>
<p>[ <a href="https://github.com/stacksaga/stacksaga-examples/blob/main/stacksaga-demo-for-kubernetes/order-service/src/main/java/org/example/dto/PlaceOrderDto.java"><span class="icon black"><i class="fa fa-github"></i></span></a> ] <code>PlaceOrderDto.ResponseBody</code></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="creating_order_initialize_executor">Creating OrderInitializeExecutor</h3>
<div class="paragraph">
<p>You know that the request comes to the <code>OrderController</code>
and the request is transferred to the <code>OrderInitializeExecutor</code> as the first step.
And next, we want to decide what OrderInitializeExecutor class type should be.
That means that there are two executor types in StackSga called <a href="../../framework/pages/command_executor.html">CommandExecutor</a> and <a href="../../framework/pages/query_executor.html">QueryExecutor</a>.</p>
</div>
<div class="paragraph">
<p>The OrderInitializeExecutor should be a command-executor because if a failure occurred at some point after executing the order initialization process, it should be recovered again.
Here we mark the order as canceled.</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/stacksaga/stacksaga-examples/blob/main/stacksaga-demo-for-kubernetes/order-service/src/main/java/org/example/executor/OrderInitializeExecutor.java"><span class="icon black"><i class="fa fa-github fa-2x"></i></span> OrderInitializeExecutor.class</a></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><i class="conum" data-value="1"></i><b>(1)</b>
<span style="color:#007">@SagaExecutor</span>(executeFor = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">order-service</span><span style="color:#710">&quot;</span></span>, liveCheck = <span style="color:#069">false</span>, value = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">OrderInitializeExecutor</span><span style="color:#710">&quot;</span></span>)
<span style="color:#007">@RequiredArgsConstructor</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">OrderInitializeExecutor</span> <span style="color:#088;font-weight:bold">implements</span> CommandExecutor&lt;PlaceOrderAggregator&gt; { <i class="conum" data-value="2"></i><b>(2)</b>

    <i class="conum" data-value="3"></i><b>(3)</b>
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> OrderService orderService;
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> ObjectMapper objectMapper;

    <span style="color:#007">@Override</span> <i class="conum" data-value="4"></i><b>(4)</b>
    <span style="color:#088;font-weight:bold">public</span> ProcessStepManager&lt;PlaceOrderAggregator&gt; doProcess(PlaceOrderAggregator currentAggregator, ProcessStepManagerUtil&lt;PlaceOrderAggregator&gt; stepManager) <span style="color:#088;font-weight:bold">throws</span> RetryableExecutorException, NonRetryableExecutorException {
        <span style="color:#080;font-weight:bold">try</span> {
            <i class="conum" data-value="5"></i><b>(5)</b>
            <span style="color:#950">this</span>.orderService.initialize(
                    OrderEntity
                            .builder()
                            .orderID(currentAggregator.getAggregatorTransactionId())
                            .createAt(LocalDateTime.now())
                            .isCancelled(<span style="color:#069">false</span>)
                            .items(objectMapper.writeValueAsString(currentAggregator.getItems()))
                            .build()
            );
        } <span style="color:#080;font-weight:bold">catch</span> (JsonProcessingException e) {
            <span style="color:#080;font-weight:bold">throw</span> <span style="color:#080;font-weight:bold">new</span> <span style="color:#C00;font-weight:bold">RuntimeException</span>(e);
        }
        <i class="conum" data-value="6"></i><b>(6)</b>
        <span style="color:#080;font-weight:bold">return</span> stepManager.next(UserDetailExecutor.class, OrderStatus.INITIALIZED_ORDER.name());
    }

    <span style="color:#007">@Override</span> <i class="conum" data-value="4"></i><b>(4)</b>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">String</span> doRevert(NonRetryableExecutorException processException, PlaceOrderAggregator finalAggregatorState, RevertHintStore revertHintStore) <span style="color:#088;font-weight:bold">throws</span> RetryableExecutorException {
        <i class="conum" data-value="7"></i><b>(7)</b>
        <span style="color:#950">this</span>.orderService.cancelOrder(finalAggregatorState.getAggregatorTransactionId());
        <i class="conum" data-value="8"></i><b>(8)</b>
        <span style="color:#080;font-weight:bold">return</span> OrderStatus.CANCELED_ORDER.name();
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the <code>OrderInitializeExecutor</code> class as a <code>SagaExecutor</code> by using <code>@SagaExecutor</code> annotation.
<div class="paragraph">
<p>Read more about <a href="../../framework/pages/saga_executors.html#saga_executors"><code>@SagaExecutor</code></a> annotation.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The class has been extended from the <code>CommandExecutor</code>.
<div class="paragraph">
<p>Read more about <a href="../../framework/pages/saga_executors.html#command_executor"><code>CommandExecutor</code></a> annotation.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Autowire the <a href="https://github.com/stacksaga/stacksaga-examples/blob/main/stacksaga-demo-for-kubernetes/order-service/src/main/java/org/example/service/internal/OrderService.java"><code>OrderService</code></a> service to make the execution.
(<code>ObjectMapper</code> has been Autowired just for getting the JSON string)</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Overridden the <code>doProcess</code> and <code>doRevert</code> methods.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Calling the initialize-method to invoke the execution.
(This method is invoked by the framework with different thread-pool.)</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>After invoking the execution successfully, <code>stepManager.next</code> command guides the framework what is the next execution after this execution.
Our next execution should be make</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="creating_user_detail_executor">Creating UserDetailExecutor</h3>
<div class="paragraph">
<p>In the <code>OrderController</code> class The <code>UserDetailExecutor</code> mentioned as the initial executor.
As per the diagram, you know that executor should be a <code>Query-Executor</code>.
Because the requirement is only fetching the user details.
Fetching user details doesn&#8217;t change any data.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><i class="conum" data-value="1"></i><b>(1)</b>
<span style="color:#007">@SagaExecutor</span>(executeFor = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">user-service</span><span style="color:#710">&quot;</span></span>, liveCheck = <span style="color:#069">false</span>, value = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">UserDetailExecutor</span><span style="color:#710">&quot;</span></span>)
<span style="color:#007">@RequiredArgsConstructor</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">UserDetailExecutor</span> <span style="color:#088;font-weight:bold">implements</span> QueryExecutor&lt;PlaceOrderAggregator&gt; { <i class="conum" data-value="2"></i><b>(2)</b>

    <i class="conum" data-value="3"></i><b>(3)</b>
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> UserService userService;

    <span style="color:#007">@Override</span>
    <span style="color:#088;font-weight:bold">public</span> ProcessStepManager&lt;PlaceOrderAggregator&gt; doProcess(
            PlaceOrderAggregator currentAggregator, <i class="conum" data-value="4"></i><b>(4)</b>
            ProcessStepManagerUtil&lt;PlaceOrderAggregator&gt; stepManager <i class="conum" data-value="5"></i><b>(5)</b>
    ) <span style="color:#088;font-weight:bold">throws</span>
    RetryableExecutorException, NonRetryableExecutorException <i class="conum" data-value="6"></i><b>(6)</b>
    {
        <i class="conum" data-value="7"></i><b>(7)</b>
        UserDetailDto.ResponseBody userDetails = <span style="color:#950">this</span>.userService.getUserDetails(currentAggregator.getUserId());
        <i class="conum" data-value="8"></i><b>(8)</b>
        currentAggregator.setDeliveryDetails(userDetails.getDeliveryDetails());
        <span style="color:#080;font-weight:bold">return</span> stepManager.next(OrderInitializeExecutor.class, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#710">&quot;</span></span>); <i class="conum" data-value="9"></i><b>(9)</b>

    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the <code>UserDetailExecutor</code> class as a <code>SagaExecutor</code> by using <code>@SagaExecutor</code> annotation.
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Read more about <a href="../../framework/pages/saga_executors.html#saga_executors"><code>@SagaExecutor</code></a> annotation.</p>
</div>
</blockquote>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Implement the <code>UserDetailExecutor</code> from the <code>QueryExecutor</code> by passing the target Aggregator.
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Read more about <a href="../../framework/pages/saga_executors.html#query_executor"><code>QueryExecutor&lt;A&gt;</code></a> interface.</p>
</div>
</blockquote>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Autowire the <a href="https://github.com/stacksaga/stacksaga-examples/blob/main/stacksaga-demo-for-kubernetes/order-service/src/main/java/org/example/service/external/UserService.java"><code>UserService</code></a>
to make the execution by calling the <code>user-service</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>you will have the <code>currentAggregator</code> object through the method parameter. due to this executor is the 1st executor, the <code>currentAggregator</code> object contains the initialized values from the <a href="#orderController_source">OrderController</a> class.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><code>stepManager</code> helps you to navigate the execution to the next executor.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>If you throw an exception, that is how the framework knows that the executor has an exception at this moment.
Based on the exception type that you have thrown, The framework decides that the process should be started the revert process or either process should be stopped temporally.
<div class="paragraph">
<p>IF the exception is a <code>RetryableExecutorException</code> the framework stops the process temporally.
Or if the exception is a <code>NonRetryableExecutorException</code> the framework knows that the execution cannot be processed to forward anymore and the revert process should be started.
Throwing an exception can be implemented in the method as well.
But in this example, we categorize the exceptions whether the exception is a <code>RetryableExecutorException</code> or otherwise a <code>NonRetryableExecutorException</code> in the <a href="#creating_user_service">UserService</a> (service layer).</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Read more about <a href="../../framework/pages/retryable_executor_exception.html">RetryableExecutorException</a> and <a href="../../framework/pages/non_retryable_executor_exception.html">NonRetryableExecutorException</a>.</p>
</div>
</blockquote>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>By using the UserService&#8217;s <code>getUserDetails()</code> method, fetches the user&#8217;s data from user <code>user-service</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>After receiving the user&#8217;s detail the <code>currentAggregator</code> is updated with user&#8217;s details.
Therefore, you can access the user&#8217;s detail within the next executor.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>By using the <code>stepManager</code>, navigates the execution to the next executor called <a href="#creating_order_initialize_executor">OrderInitializeExecutor</a>.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="creating_user_service">Creating UserService.</h3>
<div class="paragraph">
<p><code>Userservice</code> is a regular spring service that creates for calling <code>user-service</code>.
Due to the <code>user-service</code> is another utility service we have to call it through http or any other protocol that target service supports (Most probably API endpoints are exposed by http protocol).
This example&#8217;s <code>user-service</code> also support http endpoint to access the API.
Therefore, we will be using rest template as http client.
But you can use any Http client like Feign-client, Okhttp, Spring-webclient and so on.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@Service</span>
<span style="color:#007">@RequiredArgsConstructor</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">UserService</span> {

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> RestTemplate restTemplate;

    <span style="color:#088;font-weight:bold">public</span> UserDetailDto.ResponseBody getUserDetails(<span style="color:#0a8;font-weight:bold">String</span> userId)
            <span style="color:#088;font-weight:bold">throws</span>
            NonRetryableExecutorException,  RetryableExecutorException <i class="conum" data-value="1"></i><b>(1)</b>
    {

        <span style="color:#080;font-weight:bold">try</span> {
            <i class="conum" data-value="2"></i><b>(2)</b>
            UserDetailDto.ResponseBody responseBody = <span style="color:#950">this</span>.restTemplate.getForObject(
                    <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">http://user-service/users/{userId}</span><span style="color:#710">&quot;</span></span>,
                    UserDetailDto.ResponseBody.class,
                    userId
            );
            <span style="color:#080;font-weight:bold">assert</span> responseBody != <span style="color:#069">null</span>;
            <span style="color:#080;font-weight:bold">return</span> responseBody;
        } <span style="color:#080;font-weight:bold">catch</span> (HttpClientErrorException ex) { <i class="conum" data-value="3"></i><b>(3)</b>
            <span style="color:#777">// This exception is thrown for HTTP 4xx errors (Client errors)</span>
            <span style="color:#777">// You can handle specific HTTP error codes here</span>
            <span style="color:#080;font-weight:bold">if</span> (ex.getStatusCode().equals(HttpStatus.NOT_FOUND)) {
                <i class="conum" data-value="4"></i><b>(4)</b>
                <span style="color:#080;font-weight:bold">throw</span> NonRetryableExecutorException
                        .buildWith(
                                <span style="color:#080;font-weight:bold">new</span> <span style="color:#C00;font-weight:bold">RuntimeException</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">User not found</span><span style="color:#710">&quot;</span></span>),
                                <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#710">&quot;</span></span>
                        )
                        .put(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">reason</span><span style="color:#710">&quot;</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">User not found</span><span style="color:#710">&quot;</span></span>)
                        .build();
            } <span style="color:#080;font-weight:bold">else</span> {
                <i class="conum" data-value="5"></i><b>(5)</b>
                <span style="color:#080;font-weight:bold">throw</span> NonRetryableExecutorException.buildWith(ex, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#710">&quot;</span></span>).build();
            }
        } <span style="color:#080;font-weight:bold">catch</span> (HttpServerErrorException ex) { <i class="conum" data-value="6"></i><b>(6)</b>
            <span style="color:#777">// This exception is thrown for HTTP 5xx errors (Server errors)</span>
            <span style="color:#777">// You can handle specific HTTP error codes here</span>
            <span style="color:#080;font-weight:bold">if</span> (ex.getStatusCode().equals(HttpStatus.INTERNAL_SERVER_ERROR)) {
                <i class="conum" data-value="7"></i><b>(7)</b>
                <span style="color:#080;font-weight:bold">throw</span> NonRetryableExecutorException.buildWith(ex, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#710">&quot;</span></span>).build();
            } <span style="color:#080;font-weight:bold">else</span> {
                <i class="conum" data-value="8"></i><b>(8)</b>
                <span style="color:#777">//502 , 503, 504, 509 etc.</span>
                <span style="color:#080;font-weight:bold">throw</span> RetryableExecutorException.buildWith(ex).build();
            }
        } <span style="color:#080;font-weight:bold">catch</span> (RestClientException ex) { <i class="conum" data-value="9"></i><b>(9)</b>
            <span style="color:#777">// This exception is a generic RestClientException</span>
            <span style="color:#777">// Handle other types of exceptions here</span>
            <span style="color:#080;font-weight:bold">throw</span> ex; <i class="conum" data-value="10"></i><b>(10)</b>
        }
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Handling the exceptions is the most important task in StackSaga framework.
You have to handle the exception, and decide what should be the <code>NonRetryableExecutorException</code> and what should be the <code>RetryableExecutorException</code> carefully.
For example, in this demo you saw that we handled <code>NOT_FOUND</code> status.
the <code>NOT_FOUND</code> can be thrown if the <mark>endpoint not found</mark> that you are looking for.
Or otherwise it can be passed if the <mark>user does not exist</mark>.
Then, if you have not any awareness about what the target service returns, you will not be able to catch the real error.
In this example, we know exactly there is an endpoint <code>/users/{userId}</code> in the user-service therefore no worries.
But be careful if you access third party APIs.
Read the API documentation in detail.
</td>
</tr>
</table>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We have thrown both <code>NonRetryableExecutorException</code>,and <code>RetryableExecutorException</code> that UserDetailExecutor&#8217;s <code>doPrcess()</code> method expects.
That&#8217;s why it was mentioned in above.
The headlining exception part is done in the service layer.
<div class="paragraph">
<p>[ Read the <a href="#exception_tip">TIP</a> ]</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Call the http request to the user-service.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Catch the <a href="https://en.wikipedia.org/wiki/List_of_HTTP_status_codes"><strong>4xx</strong></a> HTTP errors to determine if the exception is a <code>NonRetryableExecutorException</code> or <code>RetryableExecutorException</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Due to the http error code is equal to NOT_FOUND (404), the process cannot be done anymore.
Therefore, a <code>NonRetryableExecutorException</code> is thrown by wrapping with the real exception.
If you want to put some data based on the exception, you can use the <code>put("key","value")</code> method for that.
The data can be accessed from any revert-exceptions.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Other 4xx errors are thrown as the <code>NonRetryableExecutorException</code> by wrapping the real error.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Catch the <a href="https://en.wikipedia.org/wiki/List_of_HTTP_status_codes"><strong>5xx</strong></a> HTTP errors to determine if the exception is a <code>NonRetryableExecutorException</code> or <code>RetryableExecutorException</code>.
Most probably 5xx errors can be retried, but there are some cases it can not.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Check the 5xx error is equal to <code>INTERNAL_SERVER_ERROR</code>.
Because if there is an internal server in this case, we know that we cannot go ahead and the process should be stopped going forward.
Therefore, <code>NonRetryableExecutorException</code> is thrown by wrapping the rela error.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>If the 5xx is not equal to <code>INTERNAL_SERVER_ERROR</code>, then other errors like 502, 503, 504, 509 error codes are caught as <code>RetryableExecutorException</code> and therefore a <code>RetryableExecutorException</code> is thrown by wrapping the real exception.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Cathe the other exceptions.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>In this example, that other error codes are not considered because we assume that errors cannot be happened.
Therefore, that error just throws without wrapping with <code>NonRetryableExecutorException</code>.
IF you want to wrap, you can do as usual but is not required if you don&#8217;t consider those errors.
Because internally the framework wraps the all <code>RuntimeExceptions</code> with <code>NonRetryableExecutorException</code> by default.</td>
</tr>
</table>
</div>
<div id="exception_tip" class="exampleblock">
<div class="content">
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The reason for handling the exception is that this is where the http client does the invocation and the spacial this is most probably the exceptions are different to each other even though the http status code is the same.
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Case-1</dt>
<dd>
<p>IF you change the Rest-Client (For instance, you move to RestTemplate to Feign-client), all the exceptions are changed.
Then you have to change all the codes in the executor if you have handled the exceptions inside the executor.
But in this way nothing to do anything.</p>
</dd>
<dt class="hdlist1">Case-2</dt>
<dd>
<p>If you have to change the protocol like HttpRest to GRPC, you have nothing to do in the executor layer.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_creating_preauthexecutor_command_executor">Creating PreAuthExecutor (Command-Executor)</h3>
<div class="paragraph">
<p><code>PreAuthExecutor</code> is responsible for making <code>PreAuth</code> by calling to the utility  <code>payment-service</code>.
Due to the execution should be reverted if the entire process is not successful as wished, the <code>PreAuthExecutor</code> is implemented from the <code>CommandExecutor</code> interface.
TO make the PreAuth request, we should provide the <code>userId</code>, <code>amount</code> and <code>orderId</code>.
And to revert the process we have to provide the <code>PreAuthRef</code> back.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><i class="conum" data-value="1"></i><b>(1)</b>
<span style="color:#007">@SagaExecutor</span>(executeFor = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">payment-service</span><span style="color:#710">&quot;</span></span>, liveCheck = <span style="color:#069">false</span>, value = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">PreAuthExecutor</span><span style="color:#710">&quot;</span></span>)
<span style="color:#007">@RequiredArgsConstructor</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">PreAuthExecutor</span> <span style="color:#088;font-weight:bold">implements</span> CommandExecutor&lt;PlaceOrderAggregator&gt; { <i class="conum" data-value="2"></i><b>(2)</b>
    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> PaymentService paymentService;

    <span style="color:#007">@Override</span>
    <span style="color:#088;font-weight:bold">public</span> ProcessStepManager&lt;PlaceOrderAggregator&gt; doProcess(
            PlaceOrderAggregator currentAggregator, <i class="conum" data-value="3"></i><b>(3)</b>
            ProcessStepManagerUtil&lt;PlaceOrderAggregator&gt; stepManager
    ) <span style="color:#088;font-weight:bold">throws</span> RetryableExecutorException, NonRetryableExecutorException {

        <i class="conum" data-value="4"></i><b>(4)</b>
        <span style="color:#088;font-weight:bold">final</span> <span style="color:#0a8;font-weight:bold">String</span> preAuthRef = <span style="color:#950">this</span>.paymentService.makePreAuth(
                PreAuthDto
                        .RequestBody
                        .builder()
                        .userId(currentAggregator.getUserId())
                        .amount(currentAggregator.getAmount())
                        .orderId(currentAggregator.getAggregatorTransactionId())
                        .build()
        );
        <i class="conum" data-value="5"></i><b>(5)</b>
        currentAggregator.setPreAuthRef(preAuthRef);
        <i class="conum" data-value="6"></i><b>(6)</b>
        <span style="color:#080;font-weight:bold">return</span> stepManager.next(StockUpdateExecutor.class, OrderStatus.MADE_PRE_AUTH.name());
    }

    <span style="color:#007">@Override</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">String</span> doRevert(
            NonRetryableExecutorException processException,
            PlaceOrderAggregator finalAggregatorState,
            RevertHintStore revertHintStore
    )
    <span style="color:#088;font-weight:bold">throws</span> RetryableExecutorException { <i class="conum" data-value="7"></i><b>(7)</b>

        <span style="color:#950">this</span>.paymentService.releasePreAuth(
                PreAuthReleaseDto.RequestBody.builder()
                        <i class="conum" data-value="8"></i><b>(8)</b>
                        .pareAuthRef(finalAggregatorState.getPreAuthRef())
                        <i class="conum" data-value="9"></i><b>(9)</b>
                        .reason(processException.get(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">reason</span><span style="color:#710">&quot;</span></span>).orElse(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#710">&quot;</span></span>))
                        .build()
        );
        <span style="color:#080;font-weight:bold">return</span> OrderStatus.RELEASED_PRE_AUTH.name(); <i class="conum" data-value="10"></i><b>(10)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the <code>PreAuthExecutor</code> class as a <code>SagaExecutor</code> by using <code>@SagaExecutor</code> annotation.
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Read more about <a href="../../framework/pages/saga_executors.html#saga_executors"><code>@SagaExecutor</code></a> annotation.</p>
</div>
</blockquote>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Implement the <code>PreAuthExecutor</code> from the <code>CommandExecutor</code> by passing the target Aggregator.
<div class="paragraph">
<p>Read more about <a href="../../framework/pages/saga_executors.html#command_executor"><code>CommandExecutor&lt;A&gt;</code></a> interface.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>you will have the <code>currentAggregator</code> object through the method parameter. due to this executor is the 3d executor, the <code>currentAggregator</code> object has been updated by the <code>OrderController</code>(initialization), <code>UserDetailExecutor</code>,and <code>OrderInitializeExecutor</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>make the pre-auth process by invoking the PaymentService&#8217;s <code>makePreAuth()</code> method.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Update the <code>currentAggregator</code> with <code>preAuthRef</code> data that received as the response.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Navigates the execution by using <code>stepManager</code> to the next executor called <code>StockUpdateExecutor</code>.
And also passed the status as <code>MADE_PRE_AUTH</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td><code>RetryableExecutorException</code> As per the StackSaga design pattern the revert process cannot have any <code>NonRetryableExecutorException</code> error.
It only can have <code>RetryableExecutorException</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>For Calling the PaymentService&#8217;s <code>releasePreAuth()</code> we have to provide the <code>pareAuthRef</code> data.
So we have the last aggregator data that was updated until the end of the process to forward.
Therefore, that contains the <code>pareAuthRef</code> and we can access it from the <code>finalAggregatorState</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>And As well as a reason should be given for the releasing <code>PreAuth</code>.
All the time the process can be failed (With  <code>NonRetryableExecutorException</code>)we have added a data called <code>reason</code> with the <code>NonRetryableExecutorException</code>.
This is the time that can be used.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>Return the status as <code>RELEASED_PRE_AUTH</code>  finally.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_creating_paymentservice">Creating PaymentService</h3>
<div class="paragraph">
<p><code>PaymentService</code> is a regular spring service that creates for calling utility <code>payment-service</code>.
Due to the <code>payment-service</code> is another utility service we have to call it through http or any other protocol that target service supports (Most probably API endpoints are exposed by http protocol).
This example&#8217;s <code>payment-service</code> also support http endpoint to access the API.
Therefore, we will be using rest template as http client.
But you can use any Http client like Feign-client, Okhttp, Spring-webclient and so on.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The relationship between the executor and service should not be <strong>one-to-one</strong>.
A service can be used for many executors.
In this example, the <code>PaymentService</code> class is used for <code>PreAuthExecutor</code> both executors.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@Service</span>
<span style="color:#007">@RequiredArgsConstructor</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">PaymentService</span> {

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> RestTemplate restTemplate;

    <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">String</span> makePreAuth(PreAuthDto.RequestBody requestBody)
        <span style="color:#088;font-weight:bold">throws</span> RetryableExecutorException, NonRetryableExecutorException { <i class="conum" data-value="1"></i><b>(1)</b>

        <span style="color:#080;font-weight:bold">try</span> {
            <i class="conum" data-value="2"></i><b>(2)</b>
            PreAuthDto.ResponseBody responseBody = <span style="color:#950">this</span>.restTemplate.postForObject(
                    <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">http://payment-service/pre-auth</span><span style="color:#710">&quot;</span></span>,
                    requestBody,
                    PreAuthDto.ResponseBody.class
            );
            <span style="color:#080;font-weight:bold">assert</span> responseBody != <span style="color:#069">null</span>;
            <i class="conum" data-value="3"></i><b>(3)</b>
            <span style="color:#080;font-weight:bold">return</span> responseBody.getPreAuthRef();
        } <span style="color:#080;font-weight:bold">catch</span> (HttpClientErrorException ex) { <i class="conum" data-value="4"></i><b>(4)</b>
            <span style="color:#777">// This exception is thrown for HTTP 4xx errors (Client errors)</span>
            <span style="color:#777">// You can handle specific HTTP error codes here</span>
            <span style="color:#080;font-weight:bold">if</span> (ex.getStatusCode().equals(HttpStatus.FORBIDDEN)) {
                <i class="conum" data-value="5"></i><b>(5)</b>
                <span style="color:#080;font-weight:bold">throw</span> NonRetryableExecutorException
                        .buildWith(
                                <span style="color:#080;font-weight:bold">new</span> InsufficientBalanceException(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Balance not sufficient</span><span style="color:#710">&quot;</span></span>),
                                <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#710">&quot;</span></span>
                        )
                        .build();
            } <span style="color:#080;font-weight:bold">else</span> {
                <i class="conum" data-value="6"></i><b>(6)</b>
                <span style="color:#080;font-weight:bold">throw</span> NonRetryableExecutorException.buildWith(ex, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#710">&quot;</span></span>).build();
            }
        } <span style="color:#080;font-weight:bold">catch</span> (HttpServerErrorException ex) {  <i class="conum" data-value="7"></i><b>(7)</b>
            <span style="color:#777">// This exception is thrown for HTTP 5xx errors (Server errors)</span>
            <span style="color:#777">// You can handle specific HTTP error codes here</span>
            <span style="color:#080;font-weight:bold">if</span> (ex.getStatusCode().equals(HttpStatus.INTERNAL_SERVER_ERROR)) {
                <i class="conum" data-value="8"></i><b>(8)</b>
                <span style="color:#080;font-weight:bold">throw</span> NonRetryableExecutorException.buildWith(ex, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#710">&quot;</span></span>).build();
            } <span style="color:#080;font-weight:bold">else</span> {
                <span style="color:#777">//502 , 503, 504, 509 etc.</span>
                <i class="conum" data-value="9"></i><b>(9)</b>
                <span style="color:#080;font-weight:bold">throw</span> RetryableExecutorException.buildWith(ex).build();
            }
        } <span style="color:#080;font-weight:bold">catch</span> (RestClientException ex) {  <i class="conum" data-value="10"></i><b>(10)</b>
            <span style="color:#777">// This exception is a generic RestClientException</span>
            <span style="color:#777">// Handle other types of exceptions here</span>
            <i class="conum" data-value="11"></i><b>(11)</b>
            <span style="color:#080;font-weight:bold">throw</span> ex;
        }

    }

    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> releasePreAuth(PreAuthReleaseDto.RequestBody requestBody) <span style="color:#088;font-weight:bold">throws</span> RetryableExecutorException {
        <span style="color:#080;font-weight:bold">try</span> {
            <i class="conum" data-value="12"></i><b>(12)</b>
            <span style="color:#950">this</span>.restTemplate.put(
                    <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">http://payment-service/pre-auth/release</span><span style="color:#710">&quot;</span></span>,
                    requestBody
            );
        } <span style="color:#080;font-weight:bold">catch</span> (HttpServerErrorException ex) {<i class="conum" data-value="13"></i><b>(13)</b>
            <span style="color:#777">// This exception is thrown for HTTP 5xx errors (Server errors)</span>
            <span style="color:#777">// You can handle specific HTTP error codes here</span>
            <span style="color:#080;font-weight:bold">if</span> (ex.getStatusCode().equals(HttpStatus.INTERNAL_SERVER_ERROR)) {
                <i class="conum" data-value="14"></i><b>(14)</b>
                <span style="color:#080;font-weight:bold">throw</span> NonRetryableExecutorException.buildWith(ex, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#710">&quot;</span></span>).build();
            } <span style="color:#080;font-weight:bold">else</span> {
                <span style="color:#777">//502 , 503, 504, 509 etc.</span>
                <i class="conum" data-value="15"></i><b>(15)</b>
                <span style="color:#080;font-weight:bold">throw</span> RetryableExecutorException.buildWith(ex).build();
            }
        } <span style="color:#080;font-weight:bold">catch</span> (RestClientException ex) { <i class="conum" data-value="16"></i><b>(16)</b>
            <span style="color:#777">// This exception is thrown for HTTP 4xx errors (Client errors)</span>
            <span style="color:#777">// You can handle specific HTTP error codes here</span>
            <i class="conum" data-value="17"></i><b>(17)</b>
            <span style="color:#080;font-weight:bold">throw</span> ex;
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We have thrown both <code>NonRetryableExecutorException</code>,and <code>RetryableExecutorException</code> that PreAuthExecutor&#8217;s <code>doPrcess()</code> method expects.
The headlining exception part is done in the service layer.
<div class="paragraph">
<p>[ Read the <a href="#exception_tip">TIP</a> ]</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Call the http request to the utility payment-service.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Returns the <code>authRef</code> that received as the response to the <code>PreAuthExecutor</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Catch the <a href="https://en.wikipedia.org/wiki/List_of_HTTP_status_codes"><strong>4xx</strong></a> HTTP errors to determine if the exception is a <code>NonRetryableExecutorException</code> or <code>RetryableExecutorException</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>An error can be thrown by the payment-service when we try to make a pre-auth if the user has no enough balance for making the pre-auth.
Therefore, the <code>FORBIDDEN</code> error code is filtered and throws it as <code>NonRetryableExecutorException</code> wrapping with a new exception called <code>InsufficientBalanceException</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Other 4xx errors are thrown as <code>NonRetryableExecutorException</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Catch the <a href="https://en.wikipedia.org/wiki/List_of_HTTP_status_codes"><strong>5xx</strong></a> HTTP errors to determine if the exception is a <code>NonRetryableExecutorException</code> or <code>RetryableExecutorException</code>.
Most probably 5xx errors can be retried, but there are some cases it can not.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Check the 5xx error is equal to <code>INTERNAL_SERVER_ERROR</code>.
Because if there is an internal server in this case, we know that we cannot go ahead and the process should be stopped going forward.
Therefore, <code>NonRetryableExecutorException</code> is thrown by wrapping the rela error.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>If the 5xx is not equal to <code>INTERNAL_SERVER_ERROR</code>, then other errors like 502, 503, 504, 509 error codes are caught as <code>RetryableExecutorException</code> and therefore a <code>RetryableExecutorException</code> is thrown by wrapping the real exception.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>Cathe the other exceptions.</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>In this example, other error codes are not considered because we assume that errors cannot be happened.
Therefore, that error just throws without wrapping with <code>NonRetryableExecutorException</code>.
IF you want to wrap, you can do as usual but is not required if you don&#8217;t consider those errors.
Because internally the framework wraps the all <code>RuntimeExceptions</code> with <code>NonRetryableExecutorException</code> by default.</td>
</tr>
<tr>
<td><i class="conum" data-value="12"></i><b>12</b></td>
<td>Making the request to the utility payment-service to release the PreAuth that we made.
This method is the Compensation of the <code>makePreAuth</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="13"></i><b>13</b></td>
<td>Catch the <a href="https://en.wikipedia.org/wiki/List_of_HTTP_status_codes"><strong>5xx</strong></a> HTTP errors to determine if the exception is a <code>NonRetryableExecutorException</code> or <code>RetryableExecutorException</code>.
Most probably 5xx errors can be retried, but there are some cases it can not.</td>
</tr>
<tr>
<td><i class="conum" data-value="14"></i><b>14</b></td>
<td>If the 5xx is not equal to <code>INTERNAL_SERVER_ERROR</code>, then other errors like 502, 503, 504, 509 error codes are caught as <code>RetryableExecutorException</code> and therefore a <code>RetryableExecutorException</code> is thrown by wrapping the real exception.</td>
</tr>
<tr>
<td><i class="conum" data-value="15"></i><b>15</b></td>
<td>If the 5xx is not equal to <code>INTERNAL_SERVER_ERROR</code>, then other errors like 502, 503, 504, 509 error codes are caught as <code>RetryableExecutorException</code> and therefore a <code>RetryableExecutorException</code> is thrown by wrapping the real exception.</td>
</tr>
<tr>
<td><i class="conum" data-value="16"></i><b>16</b></td>
<td>Cathe the other exceptions.</td>
</tr>
<tr>
<td><i class="conum" data-value="17"></i><b>17</b></td>
<td>In this example, other error codes are not considered because we assume that errors cannot be happened.
Therefore, that error just throws without wrapping with <code>NonRetryableExecutorException</code>.
IF you want to wrap, you can do as usual but is not required if you don&#8217;t consider those errors.
Because internally the framework wraps the all <code>RuntimeExceptions</code> with <code>NonRetryableExecutorException</code> by default.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_creating_stockupdateexecutor_command_executor">Creating StockUpdateExecutor (Command-Executor)</h3>
<div class="paragraph">
<p><code>StockUpdateExecutor</code> is responsible for updating (reduce) the stock by connecting with the utility stock-service.
After reducing the stock to place the order, an error occurred that reduced stock should be restored because the order will be canceled.
That means that the execution has Compensation.
Therefore, the executor should be a <code>Command-Executor</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><i class="conum" data-value="1"></i><b>(1)</b>
<span style="color:#007">@SagaExecutor</span>(executeFor = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">stock-service</span><span style="color:#710">&quot;</span></span>, liveCheck = <span style="color:#069">false</span>, value = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">StockUpdateExecutor</span><span style="color:#710">&quot;</span></span>)
<span style="color:#007">@RequiredArgsConstructor</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">StockUpdateExecutor</span> <span style="color:#088;font-weight:bold">implements</span> CommandExecutor&lt;PlaceOrderAggregator&gt; { <i class="conum" data-value="2"></i><b>(2)</b>

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> StockService stockService;

    <span style="color:#007">@Override</span>
    <span style="color:#088;font-weight:bold">public</span> ProcessStepManager&lt;PlaceOrderAggregator&gt; doProcess(
            PlaceOrderAggregator currentAggregator, <i class="conum" data-value="3"></i><b>(3)</b>
            ProcessStepManagerUtil&lt;PlaceOrderAggregator&gt; stepManager
    )
    <span style="color:#088;font-weight:bold">throws</span> RetryableExecutorException, NonRetryableExecutorException {
        <i class="conum" data-value="4"></i><b>(4)</b>
        <span style="color:#950">this</span>.stockService.updateStock(
                UpdateStockDto.RequestBody
                        .builder()
                        .orderId(currentAggregator.getAggregatorTransactionId())
                        .items(currentAggregator
                                .getItems()
                                .stream()
                                .collect(
                                        Collectors.toMap(
                                                OrderItem::getItemId,
                                                OrderItem::getQty
                                        )
                                )
                        )
                        .build()
        );
        <i class="conum" data-value="5"></i><b>(5)</b>
        <span style="color:#080;font-weight:bold">return</span> stepManager.next(MakePaymentExecutor.class, OrderStatus.UPDATED_STOCK.name());
    }

    <span style="color:#007">@Override</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">String</span> doRevert(
            NonRetryableExecutorException processException,
            PlaceOrderAggregator finalAggregatorState,
            RevertHintStore revertHintStore
    ) <span style="color:#088;font-weight:bold">throws</span> RetryableExecutorException { <i class="conum" data-value="6"></i><b>(6)</b>
        <i class="conum" data-value="7"></i><b>(7)</b>
        <span style="color:#950">this</span>.stockService.restoreStock(
                RestoreStockDto.RequestBody
                        .builder()
                        .reason(processException
                                .get(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">reason</span><span style="color:#710">&quot;</span></span>)
                                .orElse(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#710">&quot;</span></span>)
                        )
                        .build()
        );
        <i class="conum" data-value="8"></i><b>(8)</b>
        <span style="color:#080;font-weight:bold">return</span> OrderStatus.RESTORED_STOCK.name();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Highlights</strong></p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the <code>StockUpdateExecutor</code> class as a <code>SagaExecutor</code> by using <code>@SagaExecutor</code> annotation.
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Read more about <a href="../../framework/pages/saga_executors.html#saga_executors"><code>@SagaExecutor</code></a> annotation.</p>
</div>
</blockquote>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Implement the <code>StockUpdateExecutor</code> from the <code>CommandExecutor</code> by passing the target Aggregator.
<div class="paragraph">
<p>Read more about <a href="../../framework/pages/saga_executors.html#command_executor"><code>CommandExecutor&lt;A&gt;</code></a> interface.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>you will have the <code>currentAggregator</code> object through the method parameter. due to this executor is the 4th executor, the <code>currentAggregator</code> object has been updated by the <code>OrderController</code>(initialization), <code>UserDetailExecutor</code>, <code>OrderInitializeExecutor</code>,and <code>PreAuthExecutor</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>updating the stock by invoking the StockService&#8217;s <code>updateStock()</code> method. the <code>orderId</code> and <code>items</code> are passed accessing from the <code>currentAggregator</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Navigates the execution by using <code>stepManager</code> to the next executor called <code>MakePaymentExecutor</code>.
And also passed the status as <code>UPDATED_STOCK</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td><code>RetryableExecutorException</code> As per the StackSaga design pattern the revert process cannot have any <code>NonRetryableExecutorException</code> error.
It only can have <code>RetryableExecutorException</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Calling the StockService&#8217;s <code>restoreStock()</code> method to restoring the items that has been reduced in the <code>doProcess()</code> method.
To restore the Stock, we have to pass a reason.
Due to we have put a reason all the possible times
when an <code>NonRetryableExecutorException</code> is occurred in <code>doProcess</code> executions.
If the value doesn&#8217;t exist in the exception object we have passed just empty <code>String</code> there.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Reruns the status as <code>RESTORED_STOCK</code> finally.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>Related classes</strong></p>
</div>
</div>
<div class="sect2">
<h3 id="_creating_stockservice">Creating StockService</h3>
<div class="paragraph">
<p>We called the <code>StockService</code> in the <code>StockUpdateExecutor</code>.
The service <code>StockService</code> class is responsible for updating the stock or if there is an error, restore the stock by connecting with the utility <code>stock-service</code>.
So let&#8217;s create the service now.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span style="color:#007">@Service</span>
<span style="color:#007">@RequiredArgsConstructor</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">StockService</span> {

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> RestTemplate restTemplate;

    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> updateStock(UpdateStockDto.RequestBody requestBody)
            <span style="color:#088;font-weight:bold">throws</span>
            RetryableExecutorException, NonRetryableExecutorException {
        <span style="color:#080;font-weight:bold">try</span> {
            <i class="conum" data-value="1"></i><b>(1)</b>
            <span style="color:#950">this</span>.restTemplate.put(
                    <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">http://stock-service/stock</span><span style="color:#710">&quot;</span></span>,
                    requestBody
            );
        } <span style="color:#080;font-weight:bold">catch</span> (HttpServerErrorException ex) { <i class="conum" data-value="2"></i><b>(2)</b>
            <span style="color:#777">// This exception is thrown for HTTP 5xx errors (Server errors)</span>
            <span style="color:#777">// You can handle specific HTTP error codes here</span>
            <span style="color:#080;font-weight:bold">if</span> (ex.getStatusCode().equals(HttpStatus.INTERNAL_SERVER_ERROR)) {
                <span style="color:#080;font-weight:bold">throw</span> ex;
            } <span style="color:#080;font-weight:bold">else</span> {
                <span style="color:#777">//502 , 503, 504, 509 etc.</span>
                <span style="color:#080;font-weight:bold">throw</span> RetryableExecutorException.buildWith(ex).build();
            }
        } <span style="color:#080;font-weight:bold">catch</span> (RestClientException ex) { <i class="conum" data-value="3"></i><b>(3)</b>
            <span style="color:#777">// This exception is a generic RestClientException</span>
            <span style="color:#777">// Handle other types of exceptions here</span>
            <span style="color:#080;font-weight:bold">throw</span> ex;
        }

    }

    <span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">void</span> restoreStock(RestoreStockDto.RequestBody requestBody) <span style="color:#088;font-weight:bold">throws</span> RetryableExecutorException {
        <span style="color:#080;font-weight:bold">try</span> {
            <i class="conum" data-value="4"></i><b>(4)</b>
            <span style="color:#950">this</span>.restTemplate.put(
                    <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">http://stock-service/stock/restore</span><span style="color:#710">&quot;</span></span>,
                    requestBody
            );
        } <span style="color:#080;font-weight:bold">catch</span> (HttpServerErrorException ex) { <i class="conum" data-value="5"></i><b>(5)</b>
            <span style="color:#777">// This exception is thrown for HTTP 5xx errors (Server errors)</span>
            <span style="color:#777">// You can handle specific HTTP error codes here</span>
            <span style="color:#080;font-weight:bold">if</span> (ex.getStatusCode().equals(HttpStatus.INTERNAL_SERVER_ERROR)) {
                <span style="color:#080;font-weight:bold">throw</span> ex;
            } <span style="color:#080;font-weight:bold">else</span> {
                <span style="color:#777">//502 , 503, 504, 509 etc.</span>
                <span style="color:#080;font-weight:bold">throw</span> RetryableExecutorException.buildWith(ex).build();
            }
        } <span style="color:#080;font-weight:bold">catch</span> (RestClientException ex) { <i class="conum" data-value="6"></i><b>(6)</b>
            <span style="color:#777">// This exception is a generic RestClientException</span>
            <span style="color:#777">// Handle other types of exceptions here</span>
            <span style="color:#080;font-weight:bold">throw</span> ex;
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This service is also pretty much the same as the service that has been created so far.</p>
</div>
<div class="paragraph">
<p><strong>Highlights</strong></p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Call the endpoint to update the stock.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Catch the <a href="https://en.wikipedia.org/wiki/List_of_HTTP_status_codes"><strong>5xx</strong></a> HTTP errors to determine if the exception is a <code>NonRetryableExecutorException</code> or <code>RetryableExecutorException</code>.
Most probably 5xx errors can be retried, but there are some cases it can not.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Cathe the other exceptions (with 4xx errors as well).</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Call the endpoint to restore the updated stock.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Catch the <a href="https://en.wikipedia.org/wiki/List_of_HTTP_status_codes"><strong>5xx</strong></a> HTTP errors to determine if the exception is a <code>NonRetryableExecutorException</code> or <code>RetryableExecutorException</code>.
Most probably 5xx errors can be retried, but there are some cases it can not.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Cathe the other exceptions (with 4xx errors as well).</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_creating_makepaymentexecutor_command_executor">Creating MakePaymentExecutor (Command-Executor)</h3>
<div class="paragraph">
<p><code>MakePaymentExecutor</code> is the final executor as per the diagram. this executor interacts with the utility <code>payment-service</code>.
in the <code>PreAuthExecutor</code> also we accessed the utility <code>payment-service</code> for making the pre-auth.
his executor is responsible for making the real payment for that <code>pre-auth</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><i class="conum" data-value="1"></i><b>(1)</b>
<span style="color:#007">@SagaExecutor</span>(executeFor = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">stock-service</span><span style="color:#710">&quot;</span></span>, liveCheck = <span style="color:#069">false</span>, value = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">StockUpdateExecutor</span><span style="color:#710">&quot;</span></span>)
<span style="color:#007">@RequiredArgsConstructor</span>
<span style="color:#088;font-weight:bold">public</span> <span style="color:#339;font-weight:bold">class</span> <span style="color:#B06;font-weight:bold">MakePaymentExecutor</span> <span style="color:#088;font-weight:bold">implements</span> CommandExecutor&lt;PlaceOrderAggregator&gt; { <i class="conum" data-value="2"></i><b>(2)</b>

    <span style="color:#088;font-weight:bold">private</span> <span style="color:#088;font-weight:bold">final</span> PaymentService paymentService; <i class="conum" data-value="3"></i><b>(3)</b>

    <span style="color:#007">@Override</span>
    <span style="color:#088;font-weight:bold">public</span> ProcessStepManager&lt;PlaceOrderAggregator&gt; doProcess(
                PlaceOrderAggregator currentAggregator,
                ProcessStepManagerUtil&lt;PlaceOrderAggregator&gt; stepManager
    ) <span style="color:#088;font-weight:bold">throws</span> RetryableExecutorException, NonRetryableExecutorException {
        <i class="conum" data-value="4"></i><b>(4)</b>
        <span style="color:#0a8;font-weight:bold">String</span> paymentId = <span style="color:#950">this</span>.paymentService.makePayment(
                MakePaymentDto
                        .RequestBody
                        .builder()
                        .amount(currentAggregator.getAmount())
                        .pareAuthRef(currentAggregator.getPreAuthRef())
                        .userId(currentAggregator.getUserId())
                        .build()
        );
        <i class="conum" data-value="5"></i><b>(5)</b>
        currentAggregator.setPaymentId(paymentId);
        <i class="conum" data-value="6"></i><b>(6)</b>
        <span style="color:#080;font-weight:bold">return</span> stepManager.complete(OrderStatus.MADE_PAYMENT.name());
    }

    <span style="color:#007">@Override</span>
    <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">String</span> doRevert(NonRetryableExecutorException processException, PlaceOrderAggregator finalAggregatorState, RevertHintStore revertHintStore) <span style="color:#088;font-weight:bold">throws</span> RetryableExecutorException {
        <span style="color:#080;font-weight:bold">throw</span> <span style="color:#080;font-weight:bold">new</span> <span style="color:#C00;font-weight:bold">UnsupportedOperationException</span>(); <i class="conum" data-value="7"></i><b>(7)</b>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Highlights</strong></p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the <code>MakePaymentExecutor</code> class as a <code>SagaExecutor</code> by using <code>@SagaExecutor</code> annotation.
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Read more about <a href="../../framework/pages/saga_executors.html#saga_executors"><code>@SagaExecutor</code></a> annotation.</p>
</div>
</blockquote>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Implement the <code>MakePaymentExecutor</code> from the <code>CommandExecutor</code> by passing the target Aggregator.
<div class="paragraph">
<p>Read more about <a href="../../framework/pages/saga_executors.html#command_executor"><code>CommandExecutor&lt;A&gt;</code></a> interface.</p>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Autowire the <code>PaymentService</code>.
The old payment service is used this as well.
(The new methods will be updated below.)</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Calling the PaymentService&#8217;s <code>makePayment()</code> method for making the payment.
To make the payment, we have to pass the following data.
<div class="dlist">
<dl>
<dt class="hdlist1">-<code>amount</code></dt>
<dd>
<p>initialized at <code>OrderController</code></p>
</dd>
<dt class="hdlist1">-<code>pareAuthRef</code></dt>
<dd>
<p>initialized at <code>PreAuthExecutor</code></p>
</dd>
<dt class="hdlist1">-<code>userId</code></dt>
<dd>
<p>initialized at <code>OrderController</code></p>
</dd>
</dl>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Updates the payment in the <code>currentAggregator</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Due to this step is the finale execution, mentions the <strong>compiled</strong> signal to the SEC by using <code>stepManager.complete</code> method with the status as <code>MADE_PAYMENT</code>.
By mentioning <strong>compiled</strong> signal, the SEC stop the execution and mark the transaction has been successfully completed.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>All other command-executors had a Compensation but in this executor have no any execution for compensation.
The reason is that this is the final execution of this entire process and there is no any next executor can be failed.
You know that all the revert executions are called as the descending order from where the <code>NonRetryableExecutorException</code> is thrown.
Even this execution is failed for some reason, no need to do a compensation because that execution already failed.
If this execution failed for some reason, all other executed (successfully executed so far), executor&#8217;s compensations should be invoked.
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
If you add another execution after making the Payment, you must implement the <code>doRevert()</code> method.
Because that new execution is failed for some reason, the payment should be refunded.
Because the payment is already done.
</td>
</tr>
</table>
</div></td>
</tr>
</table>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Refer the <a href="#//">reference documentation</a> to see how the executions are invoked.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p><strong>Related Classes</strong></p>
</div>
</div>
<div class="sect2">
<h3 id="_updating_the_paymentservice">Updating the PaymentService.</h3>
<div class="paragraph">
<p>To make the payment, we have to create a new method in the existing <code>PaymentService</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span style="color:#088;font-weight:bold">public</span> <span style="color:#0a8;font-weight:bold">String</span> makePayment(MakePaymentDto.RequestBody requestBody) <span style="color:#088;font-weight:bold">throws</span> RetryableExecutorException, NonRetryableExecutorException {
        <span style="color:#080;font-weight:bold">try</span> {
            MakePaymentDto.ResponseBody responseBody = <span style="color:#950">this</span>.restTemplate.postForObject(
                    <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">http://payment-service/pay</span><span style="color:#710">&quot;</span></span>,
                    requestBody,
                    MakePaymentDto.ResponseBody.class
            );
            <span style="color:#080;font-weight:bold">assert</span> responseBody != <span style="color:#069">null</span>;
            log.debug(responseBody.getMessage());
            <span style="color:#080;font-weight:bold">return</span> responseBody.getPaymentRef();
        } <span style="color:#080;font-weight:bold">catch</span> (HttpClientErrorException ex) {
            <span style="color:#777">// This exception is thrown for HTTP 4xx errors (Client errors)</span>
            <span style="color:#777">// You can handle specific HTTP error codes here</span>
            <span style="color:#080;font-weight:bold">throw</span> ex;
        } <span style="color:#080;font-weight:bold">catch</span> (HttpServerErrorException ex) {
            <span style="color:#777">// This exception is thrown for HTTP 5xx errors (Server errors)</span>
            <span style="color:#777">// You can handle specific HTTP error codes here</span>
            <span style="color:#080;font-weight:bold">if</span> (ex.getStatusCode().equals(HttpStatus.INTERNAL_SERVER_ERROR)) {
                <span style="color:#080;font-weight:bold">throw</span> ex;
            } <span style="color:#080;font-weight:bold">else</span> {
                <span style="color:#777">//502 , 503, 504, 509 etc.</span>
                <span style="color:#080;font-weight:bold">throw</span> RetryableExecutorException.buildWith(ex).build();
            }
        } <span style="color:#080;font-weight:bold">catch</span> (RestClientException ex) {
            <span style="color:#777">// This exception is a generic RestClientException</span>
            <span style="color:#777">// Handle other types of exceptions here</span>
            <span style="color:#080;font-weight:bold">throw</span> ex;
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>That method is also pretty much the same as the service methods we have been implementing so far.
Just call the target utility service and handle the exception.</p>
</div>
<div class="paragraph">
<p><strong>Related Classes' links</strong></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_environment_deployment">Environment Deployment</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_testing">Testing</h2>
<div class="sectionbody">

</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2024-05-05 22:22:01 +0530
</div>
</div>
</body>
</html>